# ESC/POS Printing

Experimental notes on working with thermal printers in labs.

## Sending bytes on Linux

Generate ticket bytes and pipe them directly to a device:

```bash
curl -o ticket.bin "http://localhost:8000/api/outlet/demo/print/test?size=80mm"
# USB printers
cat ticket.bin | sudo tee /dev/usb/lp0 > /dev/null
# Serial printers
cat ticket.bin | sudo tee /dev/ttyS0 > /dev/null
```

The device paths vary by system; check `dmesg` or `lsusb` for the correct node.

## Safety

Printing raw bytes can cut paper or trigger cash drawers. Use a test printer in a
controlled environment and never send untrusted data to a device connected to a
live till.

## Fallbacks

If no printer is available, render the ticket as PDF or HTML and preview it in a
browser before sending it to hardware.

## Admin test route

POST `/admin/print/test` accepts `{"printer": "58mm"|"80mm"}` and returns
preview text containing the outlet name, a title, and a current ISO timestamp
while also publishing a message for connected print agents. This helps verify
printer connectivity from the dashboard.

## Security

Printable invoice and KOT pages include a strict Content-Security-Policy header
with a per-request nonce applied to inline styles and scripts. This limits
where external resources may load from and ensures the HTML served to browsers
matches the bytes generated by the API.

## Fonts

Invoice and KOT templates rely on [Noto Sans](https://fonts.google.com/noto) for
Latin, Devanagari and Gujarati scripts. To keep the repository free of binary
blobs, the PDF renderer downloads the required font files on first use and stores
them under `static/fonts`. Run `scripts/download_fonts.py` to pre-fetch them.

## Bridge mode

For production setups a lightweight bridge listens for print events and relays
them to a local ESC/POS device. The API publishes compact JSON messages on
`print:kot:{tenant}` whenever `/api/outlet/{tenant}/print/notify` is called.
An example agent in Python:

```python
import asyncio, json
import redis.asyncio as redis
from escpos.printer import Serial

async def main():
    r = redis.from_url("redis://localhost/0")
    p = Serial(devfile="/dev/usb/lp0")
    pubsub = r.pubsub()
    await pubsub.subscribe("print:kot:demo")
    async for msg in pubsub.listen():
        if msg["type"] != "message":
            continue
        data = json.loads(msg["data"])
        # send ESC/POS commands based on ``data``
        p.text(f"KOT {data['order_id']}\n")
        p.cut()

asyncio.run(main())
```

### systemd unit

```
[Unit]
Description=KOT print bridge
After=network.target

[Service]
ExecStart=/usr/bin/python3 /opt/kot_bridge.py
Restart=on-failure
User=pi
WorkingDirectory=/opt

[Install]
WantedBy=multi-user.target
```
